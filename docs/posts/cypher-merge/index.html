<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://csaatechnicalarts.github.io/rust-graph-databases/ name=base><title>
            
                Cypher MERGE to Update the Graph Network
            
        </title><meta content="Cypher MERGE to Update the Graph Network" property=og:title><link href=/icon/favicon.png rel=icon type=image/png><link href=https://csaatechnicalarts.github.io/rust-graph-databases/fonts.css rel=stylesheet><script src=https://csaatechnicalarts.github.io/rust-graph-databases/js/codeblock.js></script><script src=https://csaatechnicalarts.github.io/rust-graph-databases/js/toc.js></script><script src=https://csaatechnicalarts.github.io/rust-graph-databases/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Workingman's Graph Databases " href=https://csaatechnicalarts.github.io/rust-graph-databases/atom.xml rel=alternate type=application/atom+xml><link href=https://csaatechnicalarts.github.io/rust-graph-databases/theme/light.css rel=stylesheet><link href=https://csaatechnicalarts.github.io/rust-graph-databases/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://csaatechnicalarts.github.io/rust-graph-databases/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://csaatechnicalarts.github.io/rust-graph-databases/main.css media=screen rel=stylesheet><script src="https://csaatechnicalarts.github.io/rust-graph-databases/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://csaatechnicalarts.github.io/rust-graph-databases/>Workingman's Graph Databases </a><div class=socials><a class=social href=https://github.com/csaatechnicalarts/rust-graph-databases rel=me> <img alt=github src=https://csaatechnicalarts.github.io/rust-graph-databases/icons/social/github.svg> </a></div></div><nav><a href=https://csaatechnicalarts.github.io/rust-graph-databases/posts style=margin-left:.25em>/posts</a><a href=https://csaatechnicalarts.github.io/rust-graph-databases/tags style=margin-left:.25em>/tags</a><a href=https://csaatechnicalarts.github.io/rust-graph-databases/about style=margin-left:.25em>/about</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://csaatechnicalarts.github.io/rust-graph-databases/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://csaatechnicalarts.github.io/rust-graph-databases/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://csaatechnicalarts.github.io/rust-graph-databases/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><main><article><div class=title><div class=page-header>Cypher MERGE to Update the Graph Network<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2025-04-02</time> :: 314 Words <span class=tags-label>:: Tags:</span><span class=tags> <a class=post-tag href=https://csaatechnicalarts.github.io/rust-graph-databases/tags/cypher/>Cypher</a> , <a class=post-tag href=https://csaatechnicalarts.github.io/rust-graph-databases/tags/kuzudb/>KuzuDB</a> </span></div></div><div class=toc-container><h1 class=toc-title>Table of Contents</h1><ul class=toc-list><li><a href=https://csaatechnicalarts.github.io/rust-graph-databases/posts/cypher-merge/#graph-networks-are-mutable>Graph Networks are Mutable</a><li><a href=https://csaatechnicalarts.github.io/rust-graph-databases/posts/cypher-merge/#match-and-then-merge>MATCH and then MERGE</a><li><a href=https://csaatechnicalarts.github.io/rust-graph-databases/posts/cypher-merge/#source-code>Source Code</a></ul></div><section class=body><h2 id=graph-networks-are-mutable><a aria-label="Anchor link for: graph-networks-are-mutable" class=zola-anchor href=#graph-networks-are-mutable>Graph Networks are Mutable</a></h2><p><img alt src=https://csaatechnicalarts.github.io/rust-graph-databases/posts/cypher-merge/2025_0416-kuzugraph_user_city-800px.jpg><p>With the graph network we put together in <a href=../../posts/cypher-create-return>earlier posts</a>, we have users that follow one another in a unidirectional way. Let's say we want to update the database such that not only does Carly follow Akila, but Akila too in reverse. Similarly we see that Akila and Klaus do not follow one another; let's say we also want them to share a <code>Follows</code> relationship -- say Klaus follows Akila. We accomplish this in Cypher using the <code>MERGE</code> clause.<h2 id=match-and-then-merge><a aria-label="Anchor link for: match-and-then-merge" class=zola-anchor href=#match-and-then-merge>MATCH and then MERGE</a></h2><p>In the Cypher language <code>MERGE</code> is the way by which we apply updates to the graph database. To use this clause, we must first supply it with patterns that are anchored by Cypher reference variables. We do so by means of the <code>MATCH</code> clause. For example, here's how we create a relationship between two existing nodes:<pre class=language-cypher data-lang=cypher data-linenos style=color:#e6e1dc;background-color:#383838><code class=language-cypher data-lang=cypher><table><tbody><tr><td>1<td><span>MATCH (u1: User {name: 'Klaus'})
</span><tr><td>2<td><span>MATCH (u2: User {name: 'Akila'})
</span><tr><td>3<td><span>MERGE (u1)-[:Follows {since: DATE('2024-01-25')}]->(u2)
</span><tr><td>4<td><span>MERGE (u2)-[:Follows {since: DATE('2024-01-25')}]->(u1)
</span><tr><td>5<td><span>RETURN u1, u2
</span></table></code></pre><p>Here our pattern matches the reference variables <code>u1</code> and <code>u2</code> with the nodes for Klaus and Akila. With this in hand we then create a pair of <code>Follows</code> relationships and store the new information to the graph database.<p><img alt src=https://csaatechnicalarts.github.io/rust-graph-databases/posts/cypher-merge/2025_0417-kuzugraph_user_user-800px.jpg><p>Knowing all this, it becomes trivial to insert a new <code>User</code> node into the graph network and create new <code>Follows</code> relationships for it.<pre class=language-cypher data-lang=cypher data-linenos style=color:#e6e1dc;background-color:#383838><code class=language-cypher data-lang=cypher><table><tbody><tr><td>1<td><span>MATCH (c: City {name: 'Dallas'})
</span><tr><td>2<td><span>MATCH (u1: User {name: 'Carly'})
</span><tr><td>3<td><span>MERGE (u2: User {name: 'Tom', age: 22})
</span><tr><td>4<td><span>MERGE (u2)-[: LivesIn]->(c)
</span><tr><td>5<td><span>MERGE (u2)-[: Follows]->(u1)
</span><tr><td>6<td><span>MERGE (u1)-[: Follows]->(u2)
</span><tr><td>7<td><span>RETURN u1, u2, c 
</span></table></code></pre><p><img alt src=https://csaatechnicalarts.github.io/rust-graph-databases/posts/cypher-merge/2025_0418-kuzugraph_user_city-800px.jpg><p>Note that Cypher requires all <code>MATCH</code> patterns to come before <code>MERGE</code> clauses; changing the order leads to an error.<h2 id=source-code><a aria-label="Anchor link for: source-code" class=zola-anchor href=#source-code>Source Code</a></h2><p>The code cited in this post comes from <code>kuzu_merge.rs</code>. To run that however, you'll need to execute <code>kuzu_create_return.rs</code> first in order to provision a graph database and populate it with with data. <code>kuzu_create_return.rs</code> need only be executed once. Both Rust programs work with the graph database created in <code>/tmp/kuzu_db</code>.<p><a href=https://github.com/csaatechnicalarts/rust-graph-databases/blob/main/learn_cypher/src/bin/kuzu_create_return.rs>kuzu_create_return.rs</a><p><a href=https://github.com/csaatechnicalarts/rust-graph-databases/blob/main/learn_cypher/src/bin/kuzu_merge.rs>kuzu_merge.rs</a><hr></section></article></main></div>